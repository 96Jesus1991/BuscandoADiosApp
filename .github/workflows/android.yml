# ============================================================
# WORKFLOW: Build APK - Buscando a Dios App
# VersiÃ³n corregida para evitar errores de CRLF y gradlew
# ============================================================

name: Build APK

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:  # Permite ejecutar manualmente

# Forzar bash en todos los comandos run
defaults:
  run:
    shell: bash

jobs:
  build:
    name: Build Debug APK
    runs-on: ubuntu-latest
    
    steps:
      # ========== PASO 1: Checkout ==========
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ========== PASO 2: Setup JDK 17 ==========
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ========== PASO 3: Setup Android SDK ==========
      - name: ðŸ“± Set up Android SDK
        uses: android-actions/setup-android@v3

      # ========== PASO 4: Arreglar gradlew (CRLF â†’ LF) ==========
      - name: ðŸ”§ Fix gradlew line endings (CRLF to LF)
        run: |
          echo "=== Verificando gradlew ==="
          file gradlew || echo "Comando file no disponible"
          echo "=== Convirtiendo CRLF a LF ==="
          sed -i 's/\r$//' gradlew
          echo "=== Verificando despuÃ©s de conversiÃ³n ==="
          head -1 gradlew | cat -A
          echo "=== Hecho ==="

      # ========== PASO 5: Dar permisos de ejecuciÃ³n ==========
      - name: ðŸ”‘ Grant execute permission for gradlew
        run: chmod +x gradlew

      # ========== PASO 6: Verificar/Descargar Gradle Wrapper ==========
      - name: ðŸ“¦ Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: '8.2'

      # ========== PASO 7: Verificar estructura del proyecto ==========
      - name: ðŸ” Verify project structure
        run: |
          echo "=== Estructura del proyecto ==="
          ls -la
          echo ""
          echo "=== Contenido de app/ ==="
          ls -la app/ || echo "Carpeta app/ no encontrada"
          echo ""
          echo "=== Gradle wrapper ==="
          ls -la gradle/wrapper/ || echo "Gradle wrapper no encontrado"
          echo ""
          echo "=== TamaÃ±o de gradle-wrapper.jar ==="
          ls -la gradle/wrapper/gradle-wrapper.jar 2>/dev/null || echo "JAR no existe"

      # ========== PASO 8: Build con Gradle (usando wrapper del sistema) ==========
      - name: ðŸ—ï¸ Build Debug APK
        run: |
          echo "=== Iniciando build ==="
          gradle assembleDebug --no-daemon --stacktrace
        env:
          GRADLE_OPTS: "-Xmx2048m -Dfile.encoding=UTF-8"

      # ========== PASO 9: Listar APKs generadas ==========
      - name: ðŸ“‹ List generated APKs
        run: |
          echo "=== APKs generadas ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "No se encontraron APKs"
          echo ""
          echo "=== Contenido de outputs ==="
          ls -laR app/build/outputs/apk/ 2>/dev/null || echo "Directorio no existe"

      # ========== PASO 10: Subir APK como artifact ==========
      - name: ðŸ“¤ Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: BuscandoADios-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
          retention-days: 30

      # ========== PASO 11: Resumen del build ==========
      - name: âœ… Build Summary
        if: success()
        run: |
          echo "=========================================="
          echo "âœ… BUILD EXITOSO"
          echo "=========================================="
          echo "APK generada en: app/build/outputs/apk/debug/app-debug.apk"
          APK_SIZE=$(ls -lh app/build/outputs/apk/debug/app-debug.apk | awk '{print $5}')
          echo "TamaÃ±o del APK: $APK_SIZE"
          echo "=========================================="

